<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>格式化輸出系統 demo</title>
    <link rel="stylesheet" href="./public/css.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

</head>

<body>
    <div class="file-container">
        <div class="fileSideBar">
            <div class="file-opt">
                <h4>請選擇檔案:</h4>
                <br>
                <input type="file" name="files" id="files" value="" />
                <div class="clear-btn">
                    <button type="button" id="clear-btn">資料清除</button>
                    <button type="button" class="py-btn">Python</button>
                </div>
                <br>
                <h5>下載:</h5>
                <div class="download-btn">
                    <button type="button">
                        <a id="json-link">Json.json</a>
                    </button>
                </div>

            </div>
        </div>
        <div class="file">
            <div class="header">
                <div class="file-title">格式化輸出系統</div>
            </div>
            <div class="chat-messages" style="background-color:white;">
            </div>
        </div>
    </div>
    <div class="footer">
    </div>




    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <!-- <script src="js/jquery.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>


</body>


<script>
    let files = document.getElementById('files');
    const clearFile_btn = document.querySelector("#clear-btn");
    const showPythonFile = document.querySelector('.py-btn');
    let json_file = document.getElementById('json-link');
    let originData = ""; //用於儲存抓進來的資料
    const splitKeyWord = "\r\n";
    //切割用keyword 需要調整從這邊弄 
    const reg = /^\w[a-zA-z]+\:|.*AJCC.*|.*ajcc.*/mg;
    // 正則表達式 選取對象 
    // 於開頭的 "任意文字:" (含大小寫) or 任何含AJCC的行
    let section = originData.split(reg);
    // 先切段落
    let keyword = ""; //用於儲存段落關鍵字
    let contentArray = ""; //用於儲存段落內容
    let jsonObject = { "data": [] }; //最後要輸出出去的json物件
    let updateArray = [];

    files.onchange = function () {
        let file = files.files[0];
        let reader = new FileReader();
        reader.readAsText(file);
        reader.onload = function () {
            originData = reader.result;
            //originData = 原始資料 抓進來的資料 
            for (i = 0; i < section.length; i++) {
                console.log(section);
                createSectionDiv(i);
                var NewData = section[i].toString().split(splitKeyWord);
                let final = NewData.filter(function (value) {
                    return value !== "\r";
                })
                for (j = 0; j < final.length; j++) {
                    if (final[j] != "") {
                        createForm(final[j]);
                    }
                }
            }

            dataProcess(); //呼叫資料處理的函式
            let str_obj = JSON.stringify(jsonObject);
            let json = new Blob([str_obj], {
                type: "application/json;charset = utf-8",
            })
            json_file.href = URL.createObjectURL(json)
            json_file.download = 'abc';
            clearOldData(); //每次下載完都要呼叫清理舊資料的函式

            clearFile_btn.addEventListener("click", function () {
                //清除資料
                let parent_node = document.querySelector(".chat-messages")
                let child_node = parent_node.lastElementChild;
                files.value = '';
                if (child_node) {
                    while (child_node) {
                        parent_node.removeChild(child_node);
                        child_node = parent_node.lastElementChild;
                    }
                }
            });


        }
    }

    //資料處理函式
    function dataProcess() {
        keyword = originData.match(reg); //先抓出段落關鍵字
        section = originData.split(reg); //再把各段落切出來
        section = section.filter(v => v); //去除空值
        for (let i = 0; i < section.length; i++) {
            contentArray = section[i].split(splitKeyWord);
            for (let j = 0; j < contentArray.length; j++) {
                if (contentArray[j] === " ") { //去除切割完陣列的空白值
                    contentArray[j] = ""; //轉換成空值 之後一起去除
                }
            }
            contentArray = contentArray.filter(v => v); //去除空值
            console.log(contentArray);
            let objContent = {
                "Type": keyword[i],
                "Sentences":
                    contentArray

            };
            updateArray.push(objContent); //先push到陣列裡
            jsonObject.data = updateArray; //再把整個陣列丟進object裡
        }
        // console.log(JSON.stringify(jsonObject));
    }
    //資料顯示函式
    function createSectionDiv(x) {
        //創造段落區塊
        const secDiv = document.createElement('div');
        secDiv.classList.add('section' + x);
        secDiv.classList.add('sectionColor');
        document.querySelector('.chat-messages').appendChild(secDiv);
        //keyword塞回段落中
        const div = document.createElement('div');
        div.classList.add('message');
        if (keyword[i - 1] != undefined) {
            //會重複一次 要-1 而 最開始的會undefined 所以要過濾掉
            div.innerText = keyword[i - 1];
        }
        document.querySelector('.section' + i).appendChild(div);
    }

    function createForm(y) {
        //創造分句
        const div = document.createElement('div');
        div.classList.add('message');
        div.innerText = y;
        document.querySelector('.section' + i).appendChild(div);
    }
    function clearOldData() {
        keyword = "";
        section = "";
        contentArray = "";
        updateArray = [];
    }

    // ------------------- python接口 --------------------- //
    showPythonFile.addEventListener('click', function () {

        $.ajax({
            url: "",/*檔案路徑*/
            method: 'GET',
            success: function (pythonData) {
                console.log(pythonData);
            }
        });

    });
     // ------------------- 接口結束 --------------------- //
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

</html>