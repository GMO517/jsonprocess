<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>格式化輸出系統 demo</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
	<link rel="stylesheet" href="./public/style.css">

</head>

<body>
	<div class="main">
		<div class="content shadow p-3 mb-5 bg-body rounded">
			<div class="row">
				<div class="col-12">
					<div class="title">
						格式化輸出系統
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-3">
					<div class="side-bar">
						<div class="input-option">
							<div class="input-btn">
								請選擇檔案:
								<input type="file" name="files" id="files" value="" / class="file-btn">
								<button type="button" class="btn btn-light" id="clear-btn">資料清除</button>
							</div>
						</div>
						<div class="output-option">
							<div class="output-btn">
								請選擇輸出方式:
								<button type="button" class="btn btn-light" id="json-btn">
									<a id="json-link">json</a>
								</button><br>
								<button type="button" class="btn btn-light" id="py-btn">python</button>
							</div>
						</div>
					</div>
				</div>
				<div class="col-9">
					<div class="message-show">
						<!-- 原始資料處理過後顯示區塊 -->
					</div>
				</div>
				<div class="col-3" style="display:none">
					<!-- json檔案輸出顯示 -->
					<div class="json-show"></div>
				</div>
				<div class="col-3" style="display:none">
					<!-- python資料讀入區塊 -->
					<div class="python-show"></div>
				</div>
			</div>
		</div>
	</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- ---------- -->

<!-- jquery CDN -->
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
	crossorigin="anonymous"></script>

<script>
	const files = document.getElementById('files');
	const clearFile_btn = document.querySelector("#clear-btn");
	const showPythonFile = document.querySelector('#py-btn');
	// const json_file = document.querySelector('#json-btn');
	let json_file = document.getElementById('json-link');
	let originData = ""; //用於儲存抓進來的資料
	const splitKeyWord = "\r\n";
	//切割用keyword 需要調整從這邊弄 
	const reg = /^\w[a-zA-z]+\:|.*AJCC.*|.*ajcc.*/mg;
	// 正則表達式 選取對象 
	// 於開頭的 "任意文字:" (含大小寫) or 任何含AJCC的行
	let section = originData.split(reg);
	// 先切段落
	let keyword = ""; //用於儲存段落關鍵字
	let contentArray = ""; //用於儲存段落內容
	let jsonObject = { "data": [] }; //最後要輸出出去的json物件
	let updateArray = [];
	let processedData = "";
	let contentShowSave = [];
	files.onchange = function () {
		let file = files.files[0];
		let reader = new FileReader();
		reader.readAsText(file);
		reader.onload = function () {
			originData = reader.result;
			//originData = 原始資料 抓進來的資料 
			dataProcess(); //呼叫資料處理的函式
			keywordShow();
			// contentShow();
			let str_obj = JSON.stringify(jsonObject);
			let json = new Blob([str_obj], {
				type: "application/json;charset = utf-8",
			});
			json_file.href = URL.createObjectURL(json);
			json_file.download = 'abc';
			clearOldData(); //每次下載完都要呼叫清理舊資料的函式
		}
	}
	clearFile_btn.addEventListener("click", clearContent);
	//清除資料

	// ------------------ python接口 --------------------- //
	showPythonFile.addEventListener('click', function () {
		$.ajax({
			url: "",/*檔案路徑 這邊放本地檔案路徑*/
			method: 'GET',
			success: function (pythonData) {
				console.log(pythonData); //抓入的資料//
			}
		});

	});
	// ------------------- 接口結束 --------------------- //


	//資料顯示函式
	function keywordShow() {
		//創造段落區塊
		//keyword塞回段落中
		for (let i = 0; i < keyword.length; i++) {
			const secDiv = document.createElement('div');
			secDiv.classList.add('section' + i);
			secDiv.classList.add('sectionColor');
			secDiv.innerText = keyword[i];
			document.querySelector('.message-show').appendChild(secDiv);
			for (let j = 0; j < contentShowSave[i].length; j++) {
				let content = document.createElement('div');
				content.innerText = contentShowSave[i][j];
				document.querySelector('.section' + i).appendChild(content);
			}
		}
	}
	//資料處理函式
	function dataProcess() {
		keyword = originData.match(reg); //先抓出段落關鍵字
		section = originData.split(reg); //再把各段落切出來
		section = section.filter(v => v); //去除空值
		for (let i = 0; i < section.length; i++) {
			contentArray = section[i].split(splitKeyWord);
			for (let j = 0; j < contentArray.length; j++) {
				if (contentArray[j] === " ") { //去除切割完陣列的空白值
					contentArray[j] = ""; //轉換成空值 之後一起去除
				}
			}
			contentArray = contentArray.filter(v => v); //去除空值
			contentShowSave[i] = contentArray;
			let objContent = {
				"Type": keyword[i],
				"Sentences":
					contentArray
			};
			updateArray.push(objContent); //先push到陣列裡
			jsonObject.data = updateArray; //再把整個陣列丟進object裡
		}
		// console.log(JSON.stringify(jsonObject));
		return jsonObject;
	}
	//清除資料
	function clearOldData() {
		keyword = "";
		section = "";
		contentArray = "";
		updateArray = [];
	}
	//清除文字顯示區
	function clearContent() {
		let parent_node = document.querySelector(".message-show")
		let child_node = parent_node.lastElementChild;
		files.value = '';
		if (child_node) {
			while (child_node) {
				parent_node.removeChild(child_node);
				child_node = parent_node.lastElementChild;
			}
		}
	}
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

</html>