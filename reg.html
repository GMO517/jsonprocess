<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bootstrap demo</title>
  <link rel="stylesheet" href="./public/css.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

</head>

<body>
  <div class="fileSideBar">
    <div class="file-opt">
      <h4>請選擇檔案:</h4>
      <br>
      <input type="file" name="files" id="files" value="" />
      <div class="clear-btn">
        <button type="button" id="clear-btn">資料清除</button>
      </div>
      <br>
      <h5>下載:</h5>
      <div class="download-btn">
        <button type="button"><a id="txt-link">Test.txt</a></button>
        <button type="button"><a id="json-link">Json.json</a></button>
      </div>

    </div>
  </div>
  <div class="file-container">
    <div class="header">
      <div class="file-title">格式化輸出系統</div>
    </div>
    <div class="chat-messages" style="background-color:white;">
    </div>
  </div>
  <div class="footer">
  </div>




  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <!-- <script src="js/jquery.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
    crossorigin="anonymous"></script>


</body>


<script>

  let files = document.getElementById('files');
  const clearFile_btn = document.querySelector("#clear-btn");
  files.onchange = function () {

    let file = files.files[0];
    let reader = new FileReader();
    reader.readAsText(file);
    reader.onload = function () {

      let originData = reader.result;
      //originData = 未處理的資料
      const splitKeyWord = "\r\n";
      //切割用keyword 需要調整從這邊弄 
      const reg = /^\w[a-zA-z]+\:|.*AJCC.*|.*ajcc.*/mg;
      // 正則表達式 選取對象 
      // 於開頭的 "任意文字:" (含大小寫)
      // or
      // 任何含AJCC的行
      let section = originData.split(reg);
      // 先切段落
      let keyword = originData.match(reg);
      for (i = 0; i < section.length; i++) {
        createSectionDiv(i);
        var NewData = section[i].toString().split(splitKeyWord);
        let final = NewData.filter(function (value) {
          return value !== "\r";
        })
        for (j = 0; j < final.length; j++) {
          if (final[j] != "") {
            createForm(final[j]);
          }
        }
      }
      //======json 正則區塊======//

      let keyArray = originData.match(reg);
      console.log(keyArray);
      let contentSection = originData.split(reg);
      console.log(contentSection);

      // ======土法煉鋼區=======//
      let dataJson = {
        "data": [
          {
            "Type": keyArray[0],
            "Sentences": [
              contentSection[1]
            ]
          },
          {
            "Type": keyArray[1],
            "Sentences": [
              contentSection[2]
            ]
          },
          {
            "Type": keyArray[2],
            "Sentences": [
              contentSection[3]
            ]
          }
        ]
      }
      console.log(dataJson);
      //========================//
      // let newJson = {
      //   data: [
      //     {
      //       "Type": keyArray[0],
      //       "Sentences": [
      //         contentSection[1]
      //       ]
      //     }
      //   ]
      // }

      let newJson = {
        data: [
          {
            "Type": keyArray[0],
            "Sentences": [
              contentSection[1]
            ]
          }
        ]
      }
      // console.log(newJson);
      let test1 =
      {
        "Type": "123",
        "Sentences": [
          "a",
          "b",
          "c"
        ]
      }





      // newJson.push(test1); // 調整中
      // console.log(newJson);
      // var jsonObj = {
      //   members:
      //   {
      //     host: "hostName",
      //     viewers:
      //     {
      //       user1: "value1",
      //       user2: "value2",
      //       user3: "value3"
      //     }
      //   }
      // }

      // var i;

      // for (i = 4; i <= 8; i++) {
      //   var newUser = "user" + i;
      //   var newValue = "value" + i;
      //   jsonObj.members.viewers[newUser] = { newValue };
      // }

      // console.log(jsonObj);
      //======區塊結束======//
      clearFile_btn.addEventListener("click", function () {
        //清除資料
        let parent_node = document.querySelector(".chat-messages")
        let child_node = parent_node.lastElementChild;
        files.value = '';
        if (child_node) {
          while (child_node) {
            parent_node.removeChild(child_node);
            child_node = parent_node.lastElementChild;
          }
        }
        //AJAX//
        $.ajax({
          url: "./data/input.json",
          method: 'GET',
          dataType: 'json',
          success: function (jsonData) {
            console.log(jsonData);
          }
        });
        //----//
      })
      function createSectionDiv(x) {
        //創造段落區塊
        const secDiv = document.createElement('div');
        secDiv.classList.add('section' + x);
        secDiv.classList.add('sectionColor');
        document.querySelector('.chat-messages').appendChild(secDiv);
        //keyword塞回段落中
        const div = document.createElement('div');
        div.classList.add('message');
        if (keyword[i - 1] != undefined) {
          //會重複一次 要-1 而 最開始的會undefined 所以要過濾掉
          div.innerText = keyword[i - 1];
        }
        document.querySelector('.section' + i).appendChild(div);
      }

      function createForm(y) {
        //創造分句
        const div = document.createElement('div');
        div.classList.add('message');
        div.innerText = y;
        document.querySelector('.section' + i).appendChild(div);
      }





    }

  }






</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

</html>