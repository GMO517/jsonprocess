<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bootstrap demo</title>
  <link rel="stylesheet" href="./public/css.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

</head>

<body>
  <div class="file-container">
    <div class="fileSideBar">
      <div class="file-opt">
        <h4>請選擇檔案:</h4>
        <br>
        <input type="file" name="files" id="files" value="" />
        <div class="clear-btn">
          <button type="button" id="clear-btn">資料清除</button>
        </div>
        <br>
        <h5>下載:</h5>
        <div class="download-btn">
          <!-- <button type="button"><a id="txt-link">Test.txt</a></button> -->
          <button type="button"><a id="json-link">Json.json</a></button>
        </div>

      </div>
    </div>
    <div class="file">
      <div class="header">
        <div class="file-title">格式化輸出系統</div>
      </div>
      <div class="chat-messages" style="background-color:white;">
      </div>
    </div>
  </div>
  <div class="footer">
  </div>




  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
  <!-- <script src="js/jquery.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
    crossorigin="anonymous"></script>


</body>


<script>

  let files = document.getElementById('files');
  const clearFile_btn = document.querySelector("#clear-btn");
  files.onchange = function () {

    let file = files.files[0];
    let reader = new FileReader();
    reader.readAsText(file);
    reader.onload = function () {

      let originData = reader.result;
      //originData = 未處理的資料
      const splitKeyWord = "\r\n";
      //切割用keyword 需要調整從這邊弄 
      const reg = /^\w[a-zA-z]+\:|.*AJCC.*|.*ajcc.*/mg;
      // 正則表達式 選取對象 
      // 於開頭的 "任意文字:" (含大小寫)
      // or
      // 任何含AJCC的行
      let section = originData.split(reg);
      // 先切段落
      let keyword = originData.match(reg);
      let originObject = { "data": [] }
      let contentArray = []
      for (i = 0; i < section.length; i++) {
        createSectionDiv(i);
        var NewData = section[i].toString().split(splitKeyWord);
        var final = NewData.filter(function (value) {
          if ((value !== "\r") && (value !== "")) {
            return value;
          }
        })
        for (j = 0; j < final.length; j++) {
          createForm(final[j]);
        }
      }

      objectToJson();

      console.log(JSON.stringify(originObject));
      //======json 正則區塊======//
      function objectToJson() {
        let contentSection = originData.split(reg);
        contentSection.toString().replace(/\r\n/g, "");
        console.log(contentSection);
        for (let a = 0; a < section.length - 1; a++) {
          let objContent = {
            "Type": keyword[a],
            "Sentences": [
              contentSection[a + 1]
            ]
          };
          // console.log(objContent);
          contentArray.push(objContent);
          // console.log(contentArray);
          originObject.data = contentArray;

        }
        console.log(originObject);
        return originObject;

      }

      clearFile_btn.addEventListener("click", function () {
        //清除資料
        let parent_node = document.querySelector(".chat-messages")
        let child_node = parent_node.lastElementChild;
        files.value = '';
        if (child_node) {
          while (child_node) {
            parent_node.removeChild(child_node);
            child_node = parent_node.lastElementChild;
          }
        }
        //AJAX//
        $.ajax({
          url: "./data/input.json",
          method: 'GET',
          dataType: 'json',
          success: function (jsonData) {
            console.log(jsonData);
          }
        });
        //----//
      })
      let json_file = document.getElementById('json-link');
      let json = new Blob([JSON.stringify(originObject)], {
        type: "application/json;charset = utf-8",
      })

      json_file.href = URL.createObjectURL(json)
      json_file.download = 'abc';

      function createSectionDiv(x) {
        //創造段落區塊
        const secDiv = document.createElement('div');
        secDiv.classList.add('section' + x);
        secDiv.classList.add('sectionColor');
        document.querySelector('.chat-messages').appendChild(secDiv);
        //keyword塞回段落中
        const div = document.createElement('div');
        div.classList.add('message');
        if (keyword[i - 1] != undefined) {
          //會重複一次 要-1 而 最開始的會undefined 所以要過濾掉
          div.innerText = keyword[i - 1];
        }
        document.querySelector('.section' + i).appendChild(div);
      }

      function createForm(y) {
        //創造分句
        const div = document.createElement('div');
        div.classList.add('message');
        div.innerText = y;
        document.querySelector('.section' + i).appendChild(div);
      }




    }

  }






</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>

</html>